<html>
<head>
  <title>Awesome RTC</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes" />
  <link rel="shortcut icon" type="image/x-icon" href="css/favicon.ico">
  <link rel="stylesheet" type="text/css" href="css/style.css"/>
  <link rel="stylesheet" type="text/css" href="css/material.min.css"/>
  <link rel="chrome-webstore-item" href="https://chrome.google.com/webstore/detail/fdillhpnhjaoimfadjapbbddkdgfeedl">
</head>
<body id='body'>
  <div id="mc">
    <div id="videoContainer" class="hide"></div>
    <div id="video_controls" class="hide">
      <div id="sessionName">Hello</div>
      <table>
        <tr>
          <td>
            <button id="cam" class="greyB mdl-button mdl-js-button mdl-button--fab mdl-js-ripple-effect mdl-button--colored">
              <div class="bg24 cam"></div>
            </button>
          </td>
          <td>
            <button id="screen" class="greyB mdl-button mdl-js-button mdl-button--fab mdl-js-ripple-effect mdl-button--colored">
              <div class="bg24 screen"></div>
            </button>
          </td>
        </tr>
      </table>
    </div>
    <div id="controls" class="hide">
      <table id="access">
        <tr>
          <td>
            <button id="chat" class="greyB mdl-button mdl-js-button mdl-button--fab mdl-js-ripple-effect mdl-button--colored">
              <div class="bg24 chat"></div>
            </button>
          </td>
        </tr>
        <tr>
          <td>
            <button id="full_screen" class="greyB mdl-button mdl-js-button mdl-button--fab mdl-js-ripple-effect mdl-button--colored">
              <div class="bg36 gofs"></div>
            </button>
            <!-- <div class="mdl-tooltip mdl-tooltip--top" for="full_screen" id="full_screen_caption">Go Full-Screen</div> -->
          </td>
        </tr>
      </table>
      <table>
        <tr>
          <td>
            <button id="maudio" class="blueB mdl-button mdl-js-button mdl-button--fab mdl-js-ripple-effect mdl-button--colored">
              <div class="bg24 mute_audio"></div>
            </button>
          </td>
          <td>
            <button id="end_call" class="mdl-button mdl-js-button mdl-button--fab mdl-js-ripple-effect mdl-button--colored">
              <div class="bg36 end_call"></div>
            </button>
          </td>
          <td>
            <button id="mvideo" class="blueB mdl-button mdl-js-button mdl-button--fab mdl-js-ripple-effect mdl-button--colored">
              <div class="bg24 mute_video"></div>
            </button>
          </td>
        </tr>
      </table>
    </div>
    <div id="loader" class="hide">
      <div class="outer">
        <div class="middle">
          <div class="inner">
            <div class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="main">
    <div class="outer">
      <div class="middle">
        <div class="inner">
          <div id="action_controls">
            <div>
              Share:&nbsp;&nbsp;
              <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option-1">
                <input type="radio" id="option-1" class="mdl-radio__button" name="options" value="1" checked>
                <span class="mdl-radio__label">Camera</span>
              </label>&nbsp;&nbsp;
              <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option-2">
                <input type="radio" id="option-2" class="mdl-radio__button" name="options" onchange="checkExt(this)" value="2">
                <span class="mdl-radio__label">Screen</span>
              </label>&nbsp;&nbsp;
              <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option-3">
                <input type="radio" id="option-3" class="mdl-radio__button" name="options" value="3">
                <span class="mdl-radio__label">None</span>
              </label>
            </div>
            <br><br>
            <button id="host" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect" style="margin-right:10px;">Host</button>
            <button id="join" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect" style="margin-left:10px;">Join</button>
            <br><br>
            <div style="position: absolute;width: 100%;height: 40%;overflow-y:scroll;overflow-x:hidden;">
              <table style="margin:0 auto;min-width:50%;display:none" class="mdl-data-table mdl-js-data-table mdl-shadow--2dp">
                <tbody id="sessionCont"></tbody>
              </table>
            </div>
          </div>

          <div id="host_dialog" class="hide">
            <div class="mdl-textfield mdl-js-textfield">
              <input class="mdl-textfield__input" type="text" id="nameh">
              <label class="mdl-textfield__label" for="nameh">Give a name to the session</label>
            </div><br><br>
            <div style="float:right">
              <button id="host_cancel" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect" style="margin-right:10px;">Cancel</button>
              <button id="host_ok" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect" style="margin-left:10px;">OK</button>
            </div>
          </div>
          <div id="join_dialog" class="hide">
            <div class="mdl-textfield mdl-js-textfield">
              <input class="mdl-textfield__input" type="text" id="namej">
              <label class="mdl-textfield__label" for="namej">Give a name to the session</label>
            </div>
            <div class="mdl-textfield mdl-js-textfield">
              <input class="mdl-textfield__input" type="text" id="url">
              <label class="mdl-textfield__label" for="url">Paste the url here</label>
              <span class="mdl-textfield__error">Input is not a number!</span>
            </div><br><br>
            <div style="float:right">
              <button id="join_cancel" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect" style="margin-right:10px;">Cancel</button>
              <button id="join_ok" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect" style="margin-left:10px;">OK</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="share" class="hide">
    <div style="padding:20px;background-color:#FAFAFA;border-radius:5px;">
      <div class="mdl-textfield mdl-js-textfield" style="padding:0px;">
        <textarea readonly class="mdl-textfield__input" style="word-break:break-all;resize: none;" type="text" rows= "3" id="share_input"></textarea>
      </div>
      <button data-clipboard-target="#share_input" id="copy" style="margin-left:20px;" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect" style="margin-right:10px;"></button>
    </div>
  </div>
  <div id="chatBox">
    <div id="messageBox" style="height:100%;width:100%;display:flex;flex-flow: column;flex: 1 1 auto;background: #e5e5e5">
      <div class="msg_container_base" style="flex: 1 1 auto;position: relative;">
        <div id="chat_list" class="overflowScroll cv_msg_container_base" style="max-height: 100%;padding:0px 10px 0px 10px;;position: absolute;bottom: 0;width: 100%;"></div>
      </div>
      <div id="chat_input_con" style="">
        <textarea id="chat_input" rows="1" placeholder="Type a message ..." style="overflow: hidden; word-wrap: break-word; height: 38px;"></textarea>
      </div>
    </div>
  </div>
</body>
<script type="text/javascript" src="js/jquery-2.1.4.min.js" onload="if (typeof require != 'undefined') window.$ = window.jQuery = module.exports;"></script>
<script type="text/javascript" src="js/material.min.js"></script>
<script type="text/javascript" src="js/plugins.js"></script>
<script type="text/javascript" src="js/peerApi.js"></script>
<script type="text/javascript">

var is_chrome = navigator.userAgent.toLowerCase().indexOf('chrome') > -1;
var is_firefox = navigator.userAgent.toLowerCase().indexOf('firefox') > -1;

var is_electron = (window.process && window.process.versions && window.process.versions.electron);

var is_mobile = false;
if( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
  is_mobile = true;
}

if(is_mobile){
  $('#screen').parent().addClass('hide');
  $('#option-2').parent().addClass('hide');
}

var cp = new Clipboard('#copy');
cp.on('success', function(e) {
  $('#copy').text('Copied');
});
cp.on('error', function(e) {
  $('#copy').text('Failed');
});
var textInput = $('#share').children();

var sessionKey = getParameterByName('skey');
var fid = -1
var _skey = '';

var idb;
(function idbInit(){
  idb = new Dexie('awesomeRTC');
  idb.version(1).stores({
    sessions: '++id, skey, name, isHost, ts'
  });
  idb.version(1).stores({
    chats: '++id, fid, msg, local, ack, ts'
  });
  idb.open().catch(function(e){
    console.error('Uh oh : ', e);
  });
})();

function getSession(skey, cb){
  idb.sessions.where('skey').equals(skey).first(function(e) {
    if(cb)
      cb(e);
  });
}

function storeSession(skey, name, isHost, cb){
  idb.sessions.add({
    skey: skey,
    name: name,
    isHost: isHost,
    ts: Date.now()
  }).then(function(e){
    cb(e);
  });
}

function deleteSession(skey){
  getSession(skey, function(e){
    if(e){
      idb.sessions.where('id').equals(e.id).delete();
      idb.chats.where('fid').equals(e.id).delete();
    }
  })
}

function fetchAllSessions(cb){
  idb.sessions.toArray(function(e){
    if(cb)
      cb(e);
  })
}

function init(){
  if(sessionKey.length == 40 || sessionKey.length == 80){
    getSession(sessionKey, function(e){
      if(e){
        $('#sessionName').html(e.name);
        fid = e.id;
        startByParams();
      }
      else{
        console.log('new session');
        if(sessionKey.length == 40){
          $('#join').click();
          $('#namej').val('').parent().removeClass('is-dirty');
          $('#url').val(window.location.href).parent().addClass('is-dirty');
        }
        else if(sessionKey.length == 80){
          $('#host').click();
          $('#nameh').val('').parent().removeClass('is-dirty');
          _skey = sessionKey;
        }
      }
    });

  }
  else if(sessionKey.length > 0){
    window.location.href = window.location.href.split('?')[0];
  }
  else{
    console.log('fresh');
  }
}

function fetchSessions(){
  var tbody = $('#sessionCont');
  tbody.empty();
  fetchAllSessions(function(e){
    var sessionsArr = e;
    if(sessionsArr.length == 0)
      tbody.parent().hide();
    else
      tbody.parent().show();
    for(var i = 0; i < sessionsArr.length; i++){
      var sinfo = sessionsArr[i];
      var trstr = '';
      trstr += '<tr id="' + sinfo.skey + '"><td class="mdl-data-table__cell--non-numeric"><div class="session_name">' + sinfo.name + '</div>';
      trstr += '<div class="session_ts">' + (new Date(sinfo.ts)) + '</div></td>';
      trstr += '<td style="width:110px;">';
      if(sinfo.isHost)
        trstr += '<div id="tt' + i.toString() +'" class="icon_share"></div><div class="mdl-tooltip" for="tt' + i.toString() +'">Share</div>';
      trstr += '<div id="ttc' + i.toString() +'" class="icon_clear"></div></div><div class="mdl-tooltip" for="ttc' + i.toString() +'">Remove</div>';
      trstr += '</td></tr>';
      tbody.append(trstr);
    }
    $('.icon_share').click(function(e){
      var url = 'https://amitv87.github.io/AwesomeRTC/?skey=' + $(this).parent().parent().attr('id').substring(0,40);
      textInput.find('#share_input').val(url);
      $('#copy').text('Copy');
      textInput.popup({
        autoopen: true,
      });
      return false;
    });
    $('.icon_clear').click(function(e){
      var skey = $(this).parent().parent().attr('id');
      $(this).parent().parent().remove();
      deleteSession(skey);
      if(tbody.find('tr').length == 0)
        tbody.parent().hide();
      return false;
    });
    componentHandler.upgradeDom();
  });
}

function newSession(skey){
  var name = $('#nameh').val();
  if(name.length == 0)
    name = 'default';
  storeSession(skey, name, true, function(){
    fetchSessions();
  });
}

function proceedWithUri(name, url, cb){
  var sessionKey = getParameterByName('skey', url);
  if(sessionKey.length != 40 && sessionKey.length != 80)
    cb(false);
  else
    storeSession(sessionKey, name, sessionKey.length == 80 ? true : false, function(){
      cb(true);
    });
}

function generateSessionKey(){
  var secret = randString(40);
  var key = SHA1(secret);
  return key + secret;
}

function bindControls(){
  $('#host').click(function(){
    $('#action_controls').addClass('hide');
    $('#host_dialog').removeClass('hide');
  });
  $('#host_cancel').click(function(){
    $('#action_controls').removeClass('hide');
    $('#host_dialog').addClass('hide');
    $('#nameh').val('').parent().removeClass('is-dirty');
    _skey = '';
  });
  $('#host_ok').click(function(){
    if(_skey == '')
      newSession(generateSessionKey());
    else {
      newSession(_skey);
      window.location.href = window.location.href.split('?')[0];
    }
    $('#host_cancel').click();
  });
  $('#join').click(function(){
    $('#action_controls').addClass('hide');
    $('#join_dialog').removeClass('hide');
  })
  $('#join_cancel').click(function(){
    $('#action_controls').removeClass('hide');
    $('#join_dialog').addClass('hide');
    $('#namej').val('').parent().removeClass('is-dirty');
    $('#url').val('').parent().removeClass('is-dirty');
  });
  $('#join_ok').click(function(){
    var name = $('#namej').val();
    if(name.length == 0)
      name = 'default';
    var url = $('#url').val();
    proceedWithUri(name, url, function(e){
      if(e){
        $('#join_cancel').click();
        window.location.href = window.location.href.split('?')[0];
      }
      else
        alert('invalid url');
    });
  });
  $('#sessionCont').on('click', 'tr td:first-child', function() {
    sessionKey = $(this).parent().attr('id');
    var vid = $('input[name="options"]:checked').attr('value');
    if(vid == 1)
      vid = '#video=cam';
    else if(vid == 2)
      vid = '#video=screen';
    else
      vid = '';
    window.location.href = window.location.href.split('?')[0] + '?skey=' + sessionKey + vid;
  });

  var hidden = false;
  $('#videoContainer').click(function(){
    if(hidden){
      hidden = false;
      if(iceConnected)
        $('#video_controls').removeClass('hide');
      $('#controls').removeClass('hide');
    }
    else{
      hidden = true;
      if(iceConnected)
        $('#video_controls').addClass('hide');
      $('#controls').addClass('hide');
    }
  });

  $('#mvideo').click(function(){
    var t = $(this).find('.bg24');
    var toMute = false;
    if(t.hasClass('mute_video')){
      t.removeClass('mute_video').addClass('mute_video_off');
      toMute = true;
    }
    else{
      t.removeClass('mute_video_off').addClass('mute_video');
      toMute = false;
    }
    if(peers[DEFAULT_PEER])
      peerApi.toggleMute(peers[DEFAULT_PEER].pc, 'video', toMute);
  });

  $('#maudio').click(function(){
    var t = $(this).find('.bg24');
    var toMute = false;
    if(t.hasClass('mute_audio')){
      t.removeClass('mute_audio').addClass('mute_audio_off');
      toMute = true;
    }
    else{
      t.removeClass('mute_audio_off').addClass('mute_audio');
      toMute = false;
    }
    if(peers[DEFAULT_PEER])
      peerApi.toggleMute(peers[DEFAULT_PEER].pc, 'audio', toMute);
  })

  $('#cam').click(function(){
    var t = $(this);
    if(t.hasClass('greyB')){
      initCamSharing();
    }
    $('#screen').removeClass('blueB').addClass('greyB');
  });

  $('#screen').click(function(){
    var t = $(this);
    if(t.hasClass('greyB')){
      requestScreenCapture(initScreenSharing);
    }
    $('#cam').removeClass('blueB').addClass('greyB');
  });

  $('#end_call').click(function(){
    exitFS();
    cleanPeers();
    window.location.href = window.location.href.split('?')[0];
  });

  $('#full_screen').click(function(){
    var t = $(this).find('.bg36');
    var toMute = false;
    if(t.hasClass('gofs'))
      goFS();
    else
      exitFS();
  });

  $('#chat').click(function(){
    var t = $(this);
    if(t.hasClass('greyB')){
      t.removeClass('greyB').addClass('blueB');
      $('#mc').width('70%');
      $('#chatBox').width('30%');
      updateHash('chat', 'true');
    }
    else{
      t.removeClass('blueB').addClass('greyB');
      $('#mc').width('100%');
      $('#chatBox').width('0%');
      updateHash('chat');
    }
  });
  var ta = autosize($('#chat_input'));
  $('#chat_input').css('height', '38px');
  $('#chat_input').keypress(function (e) {
    if(e.which == 13 && !e.ctrlKey && !e.shiftKey) {
      var msg = $.trim($(this).val());
      if(msg == ""){
        e.preventDefault();
        return;
      }
      bindChatMessage(msg, true);
      $(this).val("");
      e.preventDefault();
      setTimeout(function(){
        autosize.update(ta);
      },10)
    }
  });
}

document.addEventListener('webkitfullscreenchange', fsHandler, false);
document.addEventListener('mozfullscreenchange', fsHandler, false);
document.addEventListener('fullscreenchange', fsHandler, false);
document.addEventListener('MSFullscreenChange', fsHandler, false);

function fsHandler() {
  var t = $('#full_screen').find('.bg36');
  if(isFullScreen()){
    t.removeClass('gofs').addClass('exitfs');
    $('#full_screen').removeClass('greyB').addClass('blueB');
    $('#full_screen_caption').html('Exit Full-Screen');
  }
  else{
    t.removeClass('exitfs').addClass('gofs');
    $('#full_screen').removeClass('blueB').addClass('greyB');
    $('#full_screen_caption').html('Go Full-Screen');
  }
}

function isFullScreen(){
  var resp = false
  if(document.fullscreenElement)
    resp = true;
  else if(document.webkitFullscreenElement )
    resp = true;
  else if (document.mozFullScreenElement)
    resp = true;
  return resp
}

function goFS(){
  var body = document.body;
  if (body.requestFullscreen) {
    body.requestFullscreen();
  } else if (body.msRequestFullscreen) {
    body.msRequestFullscreen();
  } else if (body.mozRequestFullScreen) {
    body.mozRequestFullScreen();
  } else if (body.webkitRequestFullscreen) {
    body.webkitRequestFullscreen();
  }
}

function exitFS() {
  if(document.exitFullscreen) {
    document.exitFullscreen();
  } else if(document.mozCancelFullScreen) {
    document.mozCancelFullScreen();
  } else if(document.webkitExitFullscreen) {
    document.webkitExitFullscreen();
  }
}

var mediaOptions = {
  video: false,
  audio: true,
}

function initScreenSharing(streamId){
  $('#screen').removeClass('greyB').addClass('blueB');
  if(is_electron){
    mediaOptions.video = {
      mandatory: {
        chromeMediaSource: 'screen',
        maxWidth: window.screen.width,
        maxHeight: window.screen.height,
      }
    }
  }
  else if(is_chrome){
    mediaOptions.video = {
      mandatory: {
        chromeMediaSource: 'desktop',
        chromeMediaSourceId: streamId,
        maxWidth: window.screen.width,
        maxHeight: window.screen.height,
      }
    }
  }
  else if(is_firefox){
    mediaOptions.video = {
      mozMediaSource: 'screen',
      mediaSource: 'screen'
    }
  }
  updateHash('video', 'screen');
  start();
}

function initCamSharing(){
  $('#cam').removeClass('greyB').addClass('blueB');
  mediaOptions.video = {
    "mandatory": {
      "minWidth": 640,
      "maxWidth": 640,
      "minHeight": 360,
      "maxHeight": 360,
      "minFrameRate": 10
    }
  }
  updateHash('video', 'cam');
  start();
}

function startByParams(){
  var videoSource = getHashParameterByName('video');
  showCallScreen();

  bindChatHistory(fid);
  if(getHashParameterByName('chat') == 'true')
    $('#chat').click();

  if(videoSource == 'cam')
    initCamSharing();
  else if(videoSource == 'screen'){
    setTimeout(function(){
      requestScreenCapture(initScreenSharing);
    }, 1000)
  }
  else
    start();
}

function showCallScreen(){
  $('#videoContainer').removeClass('hide');
  $('#controls').removeClass('hide');
  $('#loader').removeClass('hide');
  $('#video_controls').addClass('hide');
  $('#main').addClass('hide');
  $('#maudio').addClass('hide');
  $('#mvideo').addClass('hide');
}

function start(){
  preserveLocalMediaStream = false;
  showCallScreen();
  cleanPeers();
  if(ws){
    ws.close();
  }
  else
    startWS();
}

var iceConnected = false, peers = {}, ws = null, preserveLocalMediaStream = false;

function startWS(){
  var host = 'awsm.ajjas.com/ss/', secure = true;
  var wsUrl = (secure ? 'wss://' : 'ws://') + host + '?skey=' + sessionKey;

  ws = new WebSocket(wsUrl);
  ws.onopen = function(e){
    peerHandler.onChannelOpen();
  }
  window.reconnect = true;
  ws.onclose = function(e){
    peerHandler.onChannelClose();
    if(window.reconnect)
    setTimeout(function(){
      if(window.reconnect)
        startWS();
    },1000);
  }
  ws.onmessage = function(e){
    var json = JSON.parse(e.data);
    if(peerHandler[json.type])
      peerHandler[json.type](json.payload);
    else if(json.type == 'kick')
      window.reconnect = false;
  }
}

var DEFAULT_PEER = 'default';

var send = function(type, payload){
  if(ws && ws.readyState == 1)
    ws.send(JSON.stringify({type:type, payload:payload}));
  else
    return false;
}

var onStream = function(obj, source){
  window.ms = obj.stream;
  console.log('got', source, 'stream', 'id', ms.id, ms);
  // if(ms.id == 'default')
    // return;
  elm = peerApi.attachMediaStreamtoDOM(ms);
  // elm.setAttribute("controls", "true");
  elm.className = source;
  $('#videoContainer').append(elm);
  if(source == 'local'){
    elm.muted = true;
    elm.style.height = '20%'
    elm.style['z-index'] = 1;
    // elm.style['min-width'] = 200;
    elm.style['max-width'] = '50%';
    elm.style.position = 'absolute';
    elm.style.bottom = 0;
    elm.style.right = 0;
  }
  else {
    elm.style.position = 'relative';
    elm.style['vertical-align'] = 'middle';
    elm.style.width = '100%';
    elm.style.height = '100%';
  }
}

function cleanPeers(){
  if(window.localMS){
    peerApi.stopStreams(window.localMS);
    window.localMS = null;
  }
  for(var id in peers){
    removePeer(id);
  }
}

function removePeer(peerId){
  connecting();
  var peer = peers[peerId];
  if(peer){
    if(preserveLocalMediaStream)
      window.localMS = peer.pc.getLocalStreams();
    else
      peerApi.stopStreams(peer.pc.getLocalStreams());
    peerApi.stopStreams(peer.pc.getRemoteStreams());
    peer.pc.close();
    $('#videoContainer').empty();
    delete peers[peerId];
  }
}

function onMessage(dcLabel, json){
  if(peerHandler[json.type])
    peerHandler[json.type](json.payload);
  else
    console.log(dcLabel, json);
}

function sendOverWSorDC(type, payload){
  var peer = peers[DEFAULT_PEER], dc;
  if(peer && peer.pc && peer.pc.dcs){
    var dcs = peer.pc.dcs
    for (var label in dcs) {
      if(dcs[label].readyState == 'open'){
        dc = dcs[label];
        break;
      }
    };
  }
  if(dc)
    sendOverDC(dc, type, payload)
  else
    send(type, payload);
}

function sendOverDC(dc, type, payload){
  peerApi.sendOverDC(dc, {type:type, payload: payload});
}

function connecting(){
  $('#loader').removeClass('hide');
  $('#video_controls').addClass('hide');
  $('#maudio').addClass('hide');
  $('#mvideo').addClass('hide');
  iceConnected = false;
}

function connected(){
  $('#loader').addClass('hide');
  if(!$('#controls').hasClass('hide'))
    $('#video_controls').removeClass('hide');
  $('#maudio').removeClass('hide');
  $('#mvideo').removeClass('hide');
  iceConnected = true;
}

function addPeer(peerId, callback, onmsg){
  removePeer(peerId);
  var pc = peerApi.createPeerConnection(send, onStream, function(state){
    if(state)
      connected();
    else
      removePeer(peerId);
  });
  peers[peerId] = {pc:pc}
  pc.onMessage = onmsg;
  if(mediaOptions.video || mediaOptions.audio){
    peerApi.attachStream(pc, mediaOptions, onStream, window.localMS,function(e){
      preserveLocalMediaStream = true;
      console.log(e);
      callback();
    });
  }
  else
    callback();
}

var peerHandler = {
  pcCreated: false,
  onChannelOpen: function(){
    if(!iceConnected)
      send('ready', {});
  },
  ready: function(data){
    addPeer(DEFAULT_PEER, function(){
      send('offererReady', {});
    }, onMessage);
  },
  onChannelClose: function(){
    console.log('ws closed');
  },
  offererReady: function(){
    addPeer(DEFAULT_PEER, function(){
      send('answererReady', {});
    }, onMessage);
  },
  answererReady: function(){
    if(peers[DEFAULT_PEER]){
      peers[DEFAULT_PEER].isOfferer = true;
      peerApi.createOffer(peers[DEFAULT_PEER].pc, send);
    }
    else
      this.ready();
  },
  offer: function(data){
    peers[DEFAULT_PEER].isOfferer = false;
    peerApi.offer(peers[DEFAULT_PEER].pc, data, send);
  },
  answer: function(data){
    peerApi.answer(peers[DEFAULT_PEER].pc, data, send);
  },
  candidate: function(data){
    peerApi.candidate(peers[DEFAULT_PEER].pc, data, send);
  },
  chat: function(msg){
    onChatMessage(msg.m);
    sendOverWSorDC('cack', {c:msg.c});
  },
  cack: function(msg){
    $('#__cv_m' + msg.c).html(chkhtml);
    updateAck(msg.c);
  }
}

function getParameterByName(name, url) {
  name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
  var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
  results = regex.exec(url != null ? url : location.search);
  return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
}

function getHashParameterByName(name, url) {
  name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
  var regex = new RegExp("[\\#&]" + name + "=([^&#]*)"),
  results = regex.exec(url != null ? url : location.hash);
  return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
}

function updateHash(name, value) {
  name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
  var re = new RegExp("([#&])" + name + "=.*?(&|$)", "i");
  var hash = location.hash;
  if(hash.match(re)){
    if(value)
      hash = hash.replace(re, '$1' + name + "=" + value + '$2')
    else
      hash = hash.replace(re, '$1$2').replace(/\&$/, '');
  }
  else if(value)
    hash = hash + (hash.length > 1 ? '&' : '') + name + '=' + value; 
  window.location.hash = hash;
}

function randString(length) {
  var chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456879";
  var string = "";
  for (var x = 0; x < length; x++) {
      var i = Math.floor(Math.random() * chars.length);
      string += chars.charAt(i);
  }
  return string;
}

function installFFExtension(){
  var params = {
    "Foo": { URL: 'https://addons.mozilla.org/firefox/downloads/file/381774/awesome_rtc.xpi',
             IconURL: 'https://amitv87.github.io/AwesomeRTC/extensions/chrome/icons/icon96.png',
             toString: function () { return this.URL; }
    }
  };
  InstallTrigger.install(params);
}

var extensionInstalled = false;
if(is_electron)
  extensionInstalled = true;
function requestScreenCapture(cbs, cbf){
  if(is_electron)
    cbs();
  if(is_firefox){
    detectExtensionFF();
  }

  if(!extensionInstalled){
    if(cbf)
      cbf();
    console.log('extension not installed');
    if(window.chrome)
      chrome.webstore.install();
    else
      installFFExtension();
  }
  else if(cbs && !cbf){
    if(is_chrome){
      window.screenCallback = cbs;
      window.postMessage({ type: 'AwesomeRTC_UI_REQUEST', text: 'start' }, '*');
    }
    else if(is_firefox)
      cbs();
  }
  else if(cbs){
    cbs();
  }
};


function detectExtensionFF(){
  if($('body').attr('ei') == 'true')
    extensionInstalled = true;
  else
    extensionInstalled = false;
}
// listen for messages from the content-script

var chatCounter = 1, day = '';
var chkhtml = '<span class="__cv_checkmark"><div class="__cv_checkmark_stem"></div><div class="__cv_checkmark_kick"></div></span>';

if(!is_chrome && !is_firefox)
 alert('Browser not supported');
else{
  if(is_chrome){
    window.addEventListener('message', function (event) {
      if (event.origin != window.location.origin) return;

      // content-script will send a 'SS_PING' msg if extension is installed
      if (event.data.type && (event.data.type === 'AwesomeRTC_PING')) {
        console.log('AwesomeRTC_PING');
        extensionInstalled = true;
      }

      // user chose a stream
      if (event.data.type && (event.data.type === 'AwesomeRTC_DIALOG_SUCCESS')) {
        if(window.screenCallback){
          window.screenCallback(event.data.streamId);
        }
      }

      // user clicked on 'cancel' in choose media dialog
      if (event.data.type && (event.data.type === 'AwesomeRTC_DIALOG_CANCEL')) {
        console.log('User cancelled!');
      }
    });
  }
  fetchSessions();
  bindControls();
  init();
  window.onbeforeunload = function(e){
    if(ws && ws.readyState == 1){
      window.reconnect = false;
      ws.close();
    }
  };
}

function onChatMessage(message){
  bindChatMessage(message, false);
}

function bindChatMessage(message, local, ack, ts){
  function bindMessage(id){
    message = linkify(htmlEncode(message));
    var content = '<p>' + message.replace(/\n\r?/g, '<br />') + '</p>';
    var msg_str = '';
    var source = local ? 'sent' : 'receive';
    msg_str += '<div class="cv_msg_container cv_base_' + source + '">';
    msg_str += '<div class="cv_messages cv_msg_' + source + '">';
    msg_str += content;
    msg_str += '<time>' + (local ? 'you' : 'he | she') + ' / ' + getFormattedDate(ts ? ts : undefined);
    if(id)
      msg_str += '<div class="__cv_m" id="__cv_m' + id + '"></div>';
    else if(ack)
      msg_str += '<div class="__cv_m">' + chkhtml + '</div>';
    msg_str += '</time>';
    msg_str += '</div></div>';
    var target = $('#chat_list');

    var tmp = ts ? getMMMDDYYYY(ts) : getMMMDDYYYY();
      if(day != tmp){
        day = tmp;
        var dateHeader = '<div class="__cv_date_cont"><div class="__cv_date">';
        dateHeader += '<p>' + day + '</p>';
        dateHeader += '</div></div>';
        target.append(dateHeader);
      }

    target.append(msg_str);
    target.animate({ scrollTop: target[0].scrollHeight}, {
      queue: false,
      duration: 500
    });
  }
  if(!ts){
    pushChat(fid, message, local, false, function(id){
      if(local){
        sendOverWSorDC('chat', {m:message, c: id});
        bindMessage(id);
      }
      else
        bindMessage();
    });
  }
  else
    bindMessage();
}

function getChats(fid, cb){
  idb.chats.where('fid').equals(fid).toArray(function(e) {
    if(cb)
      cb(e);
  });
}

function pushChat(fid, msg, local, ack, cb){
  idb.chats.add({
    fid: fid,
    msg: msg,
    local: local,
    ack: ack,
    ts: Date.now()
  }).then(function(e){
    cb(e);
  })
}

function updateAck(fid){
  idb.chats.update(fid, {ack:true});
}

function bindChatHistory(fid){
  getChats(fid, function(chats){
    for (var i = 0; i < chats.length; i++){
      var chat = chats[i];
      bindChatMessage(chat.msg, chat.local, chat.ack, chat.ts);
    }
  });
}

function checkExt(e){
  if(e.checked){
    if(is_firefox){
      detectExtensionFF();
    }
    if(!extensionInstalled){
      $('#option-3')[0].checked = true;
      if(confirm('An Extension is require to share your screen.\r\nProceed to install.')){
        requestScreenCapture(function(){
          e.checked = true;
        }, function(){
          console.log('installing extension');
        });
      }
    }
  }
}


</script>
</html>
